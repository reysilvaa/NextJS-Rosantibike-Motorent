name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  lint-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install ESLint
      run: npm install --save-dev eslint eslint-config-next
      
    - name: Setup ESLint config
      run: |
        if [ ! -f .eslintrc.json ]; then
          echo '{
            "extends": "next/core-web-vitals"
          }' > .eslintrc.json
        fi
      
    - name: Run linting
      run: npm run lint
      
    # Uncomment jika Anda telah menambahkan tes ke proyek
    # - name: Run tests
    #   run: npm test

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install ESLint
      run: npm install --save-dev eslint eslint-config-next
      
    - name: Setup ESLint config
      run: |
        if [ ! -f .eslintrc.json ]; then
          echo '{
            "extends": "next/core-web-vitals"
          }' > .eslintrc.json
        fi
      
    - name: Build project
      run: npm run build
    
    - name: Cache build output
      uses: actions/cache@v3
      with:
        path: |
          .next
          node_modules
          public
        key: ${{ runner.os }}-nextjs-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-nextjs-

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Restore cache
      uses: actions/cache@v3
      with:
        path: |
          .next
          node_modules
          public
        key: ${{ runner.os }}-nextjs-${{ github.sha }}
        
    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
        
    - name: Update package.json with devDependencies
      run: |
        # Pastikan devDependencies ESLint ada dalam package.json
        node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.devDependencies = pkg.devDependencies || {};
          pkg.devDependencies.eslint = pkg.devDependencies.eslint || '^8.56.0';
          pkg.devDependencies['eslint-config-next'] = pkg.devDependencies['eslint-config-next'] || '^14.0.4';
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
        "
        
    - name: Deploy to VPS
      run: |
        rsync -avz --delete .next package.json package-lock.json public ecosystem.config.js .eslintrc.json root@141.11.25.200:/var/www/rosantibike/
        ssh root@141.11.25.200 "cd /var/www/rosantibike && npm ci && pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js" 
    
    - name: Send notification on success
      if: success()
      run: |
        echo "Deployment berhasil!"
        # Tambahkan notifikasi (misalnya ke Slack/Discord) jika diinginkan
    
    - name: Send notification on failure
      if: failure()
      run: |
        echo "Deployment gagal!"
        # Tambahkan notifikasi (misalnya ke Slack/Discord) jika diinginkan 